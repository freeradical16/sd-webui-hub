[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisord.log
pidfile=/var/run/supervisord.pid

; ---------- Automatic1111 ----------
[program:a1111]
directory=/opt/stable-diffusion-webui
; WEBUI_* come from environment; WEBUI_ROOT controls the data dir
command=python launch.py --listen --port=%(ENV_WEBUI_PORT)s --api --skip-torch-cuda-test --data-dir=%(ENV_WEBUI_ROOT)s %(ENV_WEBUI_ARGS)s
autostart=true
autorestart=true
startretries=3
priority=10
; log to container stdout/stderr (no rotation)
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0
environment=WEBUI_PORT="%(ENV_WEBUI_PORT)s",WEBUI_ARGS="%(ENV_WEBUI_ARGS)s",WEBUI_ROOT="%(ENV_WEBUI_ROOT)s"

; ---------- JupyterLab ----------
[program:jupyter]
directory=%(ENV_JUPYTER_ROOT)s
; Seed environment_check.ipynb into JUPYTER_ROOT once, then launch Jupyter
command=/bin/bash -c "if [ -f /opt/examples/environment_check.ipynb ] && [ ! -f %(ENV_JUPYTER_ROOT)s/environment_check.ipynb ]; then cp /opt/examples/environment_check.ipynb %(ENV_JUPYTER_ROOT)s/; echo '[init] placed %(ENV_JUPYTER_ROOT)s/environment_check.ipynb'; fi; exec jupyter lab --ip=0.0.0.0 --port=%(ENV_JUPYTER_PORT)s --no-browser --allow-root --ServerApp.root_dir=%(ENV_JUPYTER_ROOT)s --ServerApp.default_url=/lab --ServerApp.base_url=/ --ServerApp.allow_origin='*' --ServerApp.trust_xheaders=True --ServerApp.disable_check_xsrf=True --IdentityProvider.token='%(ENV_JUPYTER_TOKEN)s'"
autostart=true
autorestart=true
startretries=3
priority=20
; log to container stdout/stderr (no rotation)
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0
environment=JUPYTER_PORT="%(ENV_JUPYTER_PORT)s",JUPYTER_TOKEN="%(ENV_JUPYTER_TOKEN)s",JUPYTER_ROOT="%(ENV_JUPYTER_ROOT)s"
